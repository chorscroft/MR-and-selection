---
title: Number of children as a meeasure of fitness - is it asymptotically unbiased?
author: Clare Horscroft
---

## Packages

Load the systemfit and TwoSampleMR packages

```{r}
require(systemfit)
require(TwoSampleMR)
```

## Read in the Data
Get the SLiM data from the "children" simualation output.txt and put it into the "dat" data frame.
Get the parent ID for all the children in the next generation from parent.txt and put it into the par data frame

```{r}
setwd("~/Bristol/MR-and-selection/Simulations/children")
dat<-read.table("output.txt",header = TRUE)
par<-read.table("parent.txt",header = TRUE)
```

## Check the fitness of the individuals is as expected (0.05 higher for geno = 1)
```{r}
tapply(dat$fit,dat$geno,mean)
```

## Get number of children
Calculate the number of children each individual had and add it as an extra column in the dat data frame

```{r}
dat$children<-sapply(dat$index,function(x) sum(par$parent1==x)+sum(par$parent2==x))
tapply(dat$children,dat$geno,mean)
```

## Calculate fitness estimate using 2SLS method in systemfit

```{r}
sf<-systemfit(children~pheno,inst = ~geno,method = "2SLS",data=dat)
summary(sf)
```

## Is 2SLS the best way to do this?
This estimate could be biased due to the distribution of the number of children.
Here is a bar plot of the number of children in the dataset:

```{r}
barplot(table(dat$children),main="Number of children",xlab="Number of children",ylab="Frequency")
```

## Does the number of children follow a Poisson distribution?
Here is the graph again with the poisson distribution overlayed on top/next to it:

```{r}
c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")
barplot(table(dat$children),main="Number of children",xlab="Number of children",ylab="Frequency",col=c1)
pois<-dpois(0:10, lambda=2)*10000
barplot(pois,col=c2,add=TRUE)
legend("topright",legend=c("Observed","Poisson"),fill=c(c1,c2))
barplot(rbind(table(dat$children),pois),beside=TRUE,main="Number of children",xlab="Number of children",ylab="Frequency",col=c("black","red"))
legend("topright",legend=c("Observed","Poisson"),fill=c("black","red"))
```

This looks close. More formally, a chi-squared test can be used to see if the data is significantly different than expected given the Poisson distribution with \lambda = 2.
Any values greater than 7 have been grouped.

```{r}
chiChild<-as.vector(table(dat$children))
chiChild<-c(chiChild[1:8],sum(chiChild[9:length(chiChild)]))
chiPois<-dpois(0:7, lambda=2)*10000
chiPois<-c(chiPois,10000-sum(chiPois))

chisq.test(rbind(chiChild,chiPois))
```

The chi-sqaured test did not show eveidence to reject the null hypothesis (that the distributions are not different)

## Two Sample MR method

Firstly, start by running using a normal linear model:

```{r}
mod1<-summary(lm(dat$pheno~dat$geno))
bgx<-mod1$coefficients[2,1]
segx<-mod1$coefficients[2,2]
mod2<-summary(lm(dat$children~dat$geno))
bgy<-mod2$coefficients[2,1]
segy<-mod2$coefficients[2,2]
mr_wald_ratio(bgx,bgy,segx,segy)
```
This returns the same estimate for \beta~iv~ as in the 2SLS method.

Now try changing the lm to a glm with a Poisson family distribution:

```{r}
mod1<-summary(lm(dat$pheno~dat$geno))
bgx<-mod1$coefficients[2,1]
segx<-mod1$coefficients[2,2]
mod2<-summary(glm(dat$children~dat$geno,family=poisson("log")))
bgy<-mod2$coefficients[2,1]
segy<-mod2$coefficients[2,2]
mr_wald_ratio(bgx,bgy,segx,segy)
```



